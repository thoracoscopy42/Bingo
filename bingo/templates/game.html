{% extends "base.html" %}

{% block content %}
<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide">

      <div class="panel__top">
        <span class="panel__pill">
          Zalogowany jako: {{ request.user.username }}
        </span>


        <form method="post" action="{% url 'logout' %}" class="logout-form">
          {% csrf_token %}
          <button type="submit" class="btn btn--danger">Wyloguj</button>
        </form>

      </div>

      <form>
        <table class="grid-table">
          {% for r in rows %}
          <tr>
            {% for c in cols %}
            <td>
              <div class="cell-wrapper">
                <textarea
                  class="grid-cell grid-cell--with-select"
                  data-cell="cell_{{ r }}_{{ c }}"
                  rows="4"
                  placeholder="Wpisz zdanie..."
                ></textarea>

                {% comment %} bierzemy listę userów z backendu {% endcomment %}
                <select
                  class="cell-user cell-user--inside"
                  data-cell="cell_{{ r }}_{{ c }}"
                >
                  <option value="" selected>Przypisz użytkownika…</option>
                  {% for u in usernames %}
                    <option value="{{ u }}">{{ u }}</option>
                  {% endfor %}
                </select>
              </div>
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </table>

        <div class="actions" style="margin-top: 14px;">
          <button class="btn btn--primary" type="button" id="save-btn">Zapisz</button>
          {% comment %} <button class="btn btn--secondary" type="button" id="export-json-btn">
            Eksportuj JSON (console)
          </button> {% endcomment %}
        </div>

        <p class="fineprint">
          Każdy użytkownik może być przypisany tylko do jednego pola z wyjątkiem "Event" oraz "ktoś".
        </p>
      </form>

    </div>
  </div>
</div>

{% comment %} jeśli istnieje już zapisany template to go wrzucamy na stronkę, inaczej blank {% endcomment %}
{{ saved_grid|json_script:"saved-grid" }}


<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function loadSavedGrid() {
  const el = document.getElementById("saved-grid");
  if (!el) return;

  let saved = {};
  try { saved = JSON.parse(el.textContent || "{}"); } catch (e) { return; }

  const grid = saved.grid;
  if (!Array.isArray(grid)) return;

  const byCell = new Map();
  grid.forEach(item => {
    if (item && item.cell) byCell.set(item.cell, item);
  });

  // wczytywanie listy
  const wrappers = document.querySelectorAll(".cell-wrapper");
    wrappers.forEach(w => {
      const textarea = w.querySelector("textarea");
      const select = w.querySelector("select");
      const cellId = textarea?.dataset?.cell;
      const item = cellId ? byCell.get(cellId) : null;
      if (!item) return;

      textarea.value = item.text || "";
      select.value = item.assigned_user || "";
    });
  }

  // Event listener dla przycisku 
  document.getElementById("save-btn").addEventListener("click", async () => {
    const author = "{{ request.user.username }}";
    const timestamp = new Date().toISOString();

    const wrappers = document.querySelectorAll(".cell-wrapper");
    const grid = [];

    wrappers.forEach(w => {
      const textarea = w.querySelector("textarea");
      const select = w.querySelector("select");

      grid.push({
        cell: textarea?.dataset?.cell || null,
        text: (textarea?.value || "").trim(),
        assigned_user: (select?.value || "") || null
      });

    });

    // jeśli potem dodasz input na mail:
    // const email = (document.getElementById("email-input")?.value || "").trim();
    const email = "";

    const payload = { author, timestamp, email, grid };

    const resp = await fetch("/game/save/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify(payload),
    });

    if (resp.ok) alert("Zapisano ✅");
    else alert("Błąd zapisu ❌");
  });

  loadSavedGrid();

</script>

{% endblock %}
