{% extends "base.html" %}

{% block content %}
<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide">

      <div class="panel__top">
        <span class="panel__pill">
          Zalogowany jako: {{ request.user.username }}
        </span>
        <div class="panel__top">
          <span class="panel__pill">
            Zalogowany jako: {{ request.user.username }}
          </span>
        </div>

        <form method="post" action="{% url 'logout' %}" class="logout-form">
          {% csrf_token %}
          <button type="submit" class="btn btn--danger">Wyloguj</button>
        </form>

      </div>

      <form>
        <table class="grid-table">
          {% for r in rows %}
          <tr>
            {% for c in cols %}
            <td>
              <div class="cell-wrapper">
                <textarea
                  class="grid-cell grid-cell--with-select"
                  data-cell="cell_{{ r }}_{{ c }}"
                  rows="4"
                  placeholder="Wpisz zdanie..."
                ></textarea>

                <select
                  class="cell-user cell-user--inside"
                  data-cell="cell_{{ r }}_{{ c }}"
                >
                  <option value="" selected>Przypisz uÅ¼ytkownikaâ€¦</option>
                  <option value="test">test</option>
                  <option value="test2">test2</option>
                  <option value="bigman">bigman</option>
                  <option value="twojstary">twojstary</option>
                </select>
              </div>
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </table>

        <div class="actions" style="margin-top: 14px;">
          <button class="btn btn--primary" type="button" id="save-btn">Zapisz</button>
          <button class="btn btn--secondary" type="button" id="export-json-btn">
            Eksportuj JSON (console)
          </button>
        </div>

        <p class="fineprint">
          KaÅ¼dy uÅ¼ytkownik moÅ¼e byÄ‡ przypisany tylko do jednego pola z wyjÄ…tkiem "Event" oraz "ktoÅ›".
        </p>
      </form>

    </div>
  </div>
</div>

<script>
  // --- przypisywanie userÃ³w do pÃ³l (unikalnoÅ›Ä‡) ---
  const selects = document.querySelectorAll(".cell-user");
  const assigned = {}; // user -> cellId

  function syncDisabledOptions() {
    const takenUsers = new Set(Object.keys(assigned));

    selects.forEach(sel => {
      const current = sel.value;
      [...sel.options].forEach(opt => {
        if (!opt.value) return;
        opt.disabled = takenUsers.has(opt.value) && opt.value !== current;
      });
    });
  }

  selects.forEach(select => {
    select.addEventListener("change", () => {
      const cellId = select.dataset.cell;
      const newUser = select.value;

      const prevUser = Object.keys(assigned).find(u => assigned[u] === cellId);
      if (prevUser) delete assigned[prevUser];

      if (!newUser) {
        syncDisabledOptions();
        return;
      }

      if (assigned[newUser] && assigned[newUser] !== cellId) {
        const prevSelect = document.querySelector(`.cell-user[data-cell="${assigned[newUser]}"]`);
        if (prevSelect) prevSelect.value = "";
      }

      assigned[newUser] = cellId;
      syncDisabledOptions();
    });
  });

  syncDisabledOptions();

  // --- testowy zapis ---
  document.getElementById("save-btn").addEventListener("click", () => {
    alert("Zapis (na razie testowy) âœ…");
  });

  // --- eksport JSON do konsoli ---
  document.getElementById("export-json-btn").addEventListener("click", () => {
    const author = "{{ request.user.username }}";
    const timestamp = new Date().toISOString();

    const wrappers = document.querySelectorAll(".cell-wrapper");
    const grid = [];

    wrappers.forEach(w => {
      const textarea = w.querySelector("textarea");
      const select = w.querySelector("select");

      grid.push({
        cell: textarea?.dataset?.cell || null,
        text: (textarea?.value || "").trim(),
        assigned_user: (select?.value || "") || null
      });
    });

    const result = { author, timestamp, grid };

    console.log("ðŸ“¦ GRID EXPORT JSON:");
    console.log(JSON.stringify(result, null, 2));
    alert("JSON wypluty w Console âœ…");
  });
</script>
{% endblock %}
