{% extends "base.html" %}

{% block content %}

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div class="page">
  <div class="hero hero--wide">
    <div class="panel panel--wide">

      <div class="panel__top">
        <span class="panel__pill">
          Zalogowany jako: {{ request.user.username }}
        </span>
        


        <form method="post" action="{% url 'logout' %}" class="logout-form">
          {% csrf_token %}
          <button type="submit" class="btn btn--danger">Wyloguj</button>
        </form>

      </div>

      <form>
        <table class="grid-table">
          {% for r in rows %}
          <tr>
            {% for c in cols %}
            <td>
              <div class="cell-wrapper">
                <textarea
                  class="grid-cell grid-cell--with-select"
                  data-cell="cell_{{ r }}_{{ c }}"
                  rows="4"
                  placeholder="Wpisz zdanie..."
                ></textarea>

                {% comment %} bierzemy listę userów z backendu {% endcomment %}
                <select
                  class="cell-user cell-user--inside"
                  data-cell="cell_{{ r }}_{{ c }}"
                  data-enhance="dropdown"
                >
                <option value="" selected> </option>
                  {% for u in usernames %}
                    <option value="{{ u }}">{{ u }}</option>
                  {% endfor %}
                </select>
              </div>
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </table>

        <div class="actions" style="margin-top: 14px;">
          <button class="btn btn--primary" type="button" id="save-btn">Zapisz</button>
          {% comment %} <button class="btn btn--secondary" type="button" id="export-json-btn">
            Eksportuj JSON (console)
          </button> {% endcomment %}
          <a class="btn btn--secondary" href="{% url 'raffle' %}">Losowanie</a>
        </div>

        <p class="fineprint">
          Każdy użytkownik może być przypisany do maksymalnie dwóch pól z wyjątkiem "Event" oraz "Ktokolwiek".
        </p>
      </form>

    </div>
  </div>
</div>

{% comment %} jeśli istnieje już zapisany template to go wrzucamy na stronkę, inaczej blank {% endcomment %}
{{ saved_grid|json_script:"saved-grid" }}


<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function loadSavedGrid() {
  const el = document.getElementById("saved-grid");
  if (!el) return;

  let saved = {};
  try { saved = JSON.parse(el.textContent || "{}"); } catch (e) { return; }

  const grid = saved.grid;
  if (!Array.isArray(grid)) return;

  const byCell = new Map();
  grid.forEach(item => {
    if (item && item.cell) byCell.set(item.cell, item);
  });

  // wczytywanie listy
  const wrappers = document.querySelectorAll(".cell-wrapper");
    wrappers.forEach(w => {
      const textarea = w.querySelector("textarea");
      const select = w.querySelector("select");
      const cellId = textarea?.dataset?.cell;
      const item = cellId ? byCell.get(cellId) : null;
      if (!item) return;

      textarea.value = item.text || "";
      select.value = item.assigned_user || "";
      const btn = w.querySelector(".cd__button");
      if (btn) {
        const opt = [...select.options].find(o => o.value === select.value);
        btn.textContent = opt ? opt.text : "—";
      }
    });
  }


  let toastTimer = null;

  function showToast(message, type="success") {
    const el = document.getElementById("toast");
    if (!el) return;

    el.textContent = message;
    el.classList.remove("toast--success", "toast--error", "toast--show");
    el.classList.add(type === "error" ? "toast--error" : "toast--success");

    // reset timera
    if (toastTimer) clearTimeout(toastTimer);

    // pokaż
    requestAnimationFrame(() => el.classList.add("toast--show"));

    // schowaj po chwili
    toastTimer = setTimeout(() => {
      el.classList.remove("toast--show");
    }, 2200);
  }

  // Event listener dla przycisku 
  document.getElementById("save-btn").addEventListener("click", async () => {
    const author = "{{ request.user.username }}";
    const timestamp = new Date().toISOString();

    const wrappers = document.querySelectorAll(".cell-wrapper");
    const grid = [];

    wrappers.forEach(w => {
      const textarea = w.querySelector("textarea");
      const select = w.querySelector("select");

      grid.push({
        cell: textarea?.dataset?.cell || null,
        text: (textarea?.value || "").trim(),
        assigned_user: (select?.value || "") || null
      });

    });

    // jeśli potem dodasz input na mail:
    // const email = (document.getElementById("email-input")?.value || "").trim();
    const email = "";

    const payload = { author, timestamp, email, grid };

    const resp = await fetch("/game/save/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify(payload),
    });

    if (resp.ok) {
      showToast("UDAŁO SIĘ YIPIEE!!!", "success");
      burstConfetti(70);
    } else {
      const txt = await resp.text();
      showToast("Are you serious right meow :(" + (txt || ""), "error");
    }


  });

  //czarny dropdown
  (function enhanceDropdowns(){
  const wrappers = new Set();

  function closeAll(exceptWrapper = null){
    document.querySelectorAll(".cd--open").forEach(w => {
      if (w !== exceptWrapper) w.classList.remove("cd--open");
    });
  }

  function enhanceOne(select){
    // offscreen + nieklikalny => natywny select nie otworzy się nigdy
    select.setAttribute("aria-hidden", "true");
    select.tabIndex = -1;
    select.style.position = "absolute";
    select.style.left = "-99999px";
    select.style.width = "1px";
    select.style.height = "1px";
    select.style.opacity = "0";
    select.style.pointerEvents = "none";

    const wrapper = select.closest(".cell-wrapper");
    if (!wrapper) return;
    wrapper.classList.add("cd");
    wrappers.add(wrapper);

    // nie dubluj
    if (wrapper.querySelector(".cd__button")) return;

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "cd__button";

    const list = document.createElement("div");
    list.className = "cd__list";


    function syncFromSelect(){
      const opt = select.options[select.selectedIndex];
      btn.textContent = opt ? opt.text : "—";
    }

    // opcje
    [...select.options].forEach(opt => {
      const div = document.createElement("div");
      div.className = "cd__option";
      if (!opt.value) div.classList.add("cd__option--muted");
      div.textContent = opt.text;

      div.addEventListener("click", (e) => {
        e.stopPropagation();
        select.value = opt.value;
        syncFromSelect();
        wrapper.classList.remove("cd--open");
      });

      list.appendChild(div);
    });

    // toggle listy
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      const isOpen = wrapper.classList.contains("cd--open");
      closeAll(wrapper);
      wrapper.classList.toggle("cd--open", !isOpen);
    });

    // klik w listę nie zamyka przez document click
    list.addEventListener("click", (e) => e.stopPropagation());

    const anchor = document.createElement("div");
    anchor.className = "cd__anchor";

    anchor.appendChild(btn);
    anchor.appendChild(list);
    wrapper.appendChild(anchor);

    syncFromSelect();
  }

  // init
  document.querySelectorAll("select.cell-user--inside").forEach(enhanceOne);

  // zamykanie kliknięciem poza
  document.addEventListener("click", () => closeAll(null));

  // ESC zamyka
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeAll(null);
  });
})();

  loadSavedGrid();

 function burstConfetti(count = 70){
  const table = document.querySelector(".grid-table");
  if (!table) return;

  const rect = table.getBoundingClientRect();

  // X-y startowe przy krawędziach tabeli (trochę na zewnątrz)
  const leftX  = rect.left - 10;
  const rightX = rect.right + 10;

  // "podłoga" = dół widocznego ekranu (viewport)
  const floorY = window.innerHeight + 6;

  const wrap = document.createElement("div");
  wrap.className = "confetti";
  document.body.appendChild(wrap);

  const colors = ["#2AFF8C", "#00CDB4", "#FFFFFF", "#4C7DFF", "#FFD24C"];

  for (let i = 0; i < count; i++){
    const p = document.createElement("span");
    p.className = "confetti__piece";

    const fromLeft = Math.random() < 0.5;

    // START: dwa „emitery” przy krawędziach tabeli
    const startX = (fromLeft ? leftX : rightX) + (Math.random() * 20 - 10);
    const startY = floorY + (Math.random() * 10);

    p.style.left = startX + "px";
    p.style.top  = startY + "px";

    // RUCH:
    // - w górę (ujemny dy)
    // - lekko na boki (dx): lewy emiter bardziej w lewo, prawy bardziej w prawo
    const dx = (fromLeft ? -1 : 1) * (Math.random() * 180 + 80); // px
    const dy = -(Math.random() * 520 + 380);                     // px (mocny strzał w górę)

    const rot = (Math.random() * 900 - 450) + "deg";
    const dur = (Math.random() * 0.55 + 0.95); // 0.95..1.5s
    const delay = Math.random() * 0.06;

    // losowy rozmiar (trochę żywiej)
    const w = Math.random() * 6 + 6;    // 6..12
    const h = Math.random() * 10 + 10;  // 10..20

    p.style.width = w + "px";
    p.style.height = h + "px";
    p.style.background = colors[(Math.random() * colors.length) | 0];

    p.style.setProperty("--dx", dx + "px");
    p.style.setProperty("--dy", dy + "px");
    p.style.setProperty("--rot", rot);

    p.style.animationDuration = dur + "s";
    p.style.animationDelay = delay + "s";

    wrap.appendChild(p);
  }

  // sprzątanie po animacji
  setTimeout(() => wrap.remove(), 1800);
}





</script>

{% endblock %}
